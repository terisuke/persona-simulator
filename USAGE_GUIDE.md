# Persona Debate Simulator - 使い方ガイド

このガイドでは、Persona Debate Simulatorを使ってペルソナを作成し、議論をさせる手順を詳しく説明します。

---

## 📋 目次

1. [準備](#1-準備)
2. [アプリの起動](#2-アプリの起動)
3. [ペルソナの作成](#3-ペルソナの作成)
4. [議論を開始する](#4-議論を開始する)
5. [議論を展開する](#5-議論を展開する)
6. [高度な使い方](#6-高度な使い方)

---

## 1. 準備

### 1.1 依存関係のインストール

```bash
pip install -r requirements.txt
```

### 1.2 APIキーの設定

プロジェクトルートに `.streamlit` フォルダを作成し、`secrets.toml` ファイルを作成します：

```bash
mkdir .streamlit
```

`.streamlit/secrets.toml` の内容：

```toml
# Grok API (必須)
GROK_API_KEY = "your_grok_api_key_here"

# X API v2 (オプション - 高速取得用)
X_BEARER_TOKEN = "your_x_bearer_token_here"

# 運用モード設定（オプション）
MODE = "dev"  # prod, staging, dev のいずれか
```

**APIキーの取得方法**:
- **Grok API**: [https://x.ai/api](https://x.ai/api) から取得（必須）
- **X API**: [https://developer.x.com/](https://developer.x.com/) から取得（オプション）

> 💡 **X APIがなくても使えます**：Grok Web Searchで実投稿を取得できます。ただし、X APIがあるとより高速に取得できます。

### 1.3 環境チェック

```bash
python test_setup.py
```

エラーなく完了すれば準備完了です。

---

## 2. アプリの起動

```bash
streamlit run app.py
```

ブラウザが自動的に開き、アプリケーションが表示されます。

---

## 3. ペルソナの作成

### 3.1 アカウントを追加する

#### 方法1: 個別に追加（小規模な場合）

1. サイドバーの「📝 Xアカウント管理」セクションで「アカウント名を入力」フィールドにXアカウント名を入力
   - 例: `elonmusk`（@マークは不要）
2. 「➕ アカウント追加」ボタンをクリック
3. 自動的に投稿が取得され、ペルソナが生成されます

#### 方法2: 一括アップロード（大規模な場合）

1. **CSVまたはTXTファイルを準備**
   - **CSV**: `username`列を含むファイル
   - **TXT**: 改行区切りでアカウント名を記載（`#`で始まる行はコメント）
   
   例（`accounts.txt`）:
   ```
   elonmusk
   cor_terisuke
   # これはコメント
   billgates
   ```

2. サイドバーの「📁 一括アップロード」セクションでファイルをアップロード
3. 「📥 ファイルからアカウントを読み込み」ボタンをクリック
4. アカウントがリストに追加されます

#### 方法3: キーワードで自動収集（新機能）

1. サイドバーの「🔍 キーワードで収集」セクションでキーワードを入力
   - 例: `AI engineer`, `startup founder`
2. 最大人数をスライダーで設定（デフォルト: 50人）
3. 「🚀 収集開始」ボタンをクリック
4. 自動的にアカウント候補が発見され、リストに追加されます

> 💡 **プリセットキーワードも利用可能**: サイドバー下部の「🎲 ランダム収集を開始」ボタンで、16種類のプリセットキーワードからランダムに検索できます。

### 3.2 データ取得の進捗を確認

メインエリア上部に進捗サマリが表示されます：

- **総アカウント数**: 登録されているアカウントの総数
- **キャッシュ済み**: データが取得済みのアカウント数
- **取得待ち**: まだデータを取得していないアカウント数
- **エラー**: データ取得に失敗したアカウント数

### 3.3 バッチ処理で一括取得（推奨）

複数のアカウントを登録した場合：

1. サイドバーの「⚡ バッチ処理」セクションで「🚀 不足分を取得」ボタンをクリック
2. 10件ずつ段階的にデータが取得されます
3. 進捗バーでリアルタイムに状況を確認できます

> ⚠️ **レート制限に達した場合**: 
> - UI側では警告が表示されます
> - CLI (`python ingest_accounts.py accounts.txt`) でバッチ生成を再実行することを推奨します
> - 約15分後に再試行してください

### 3.4 ペルソナ生成の確認

各アカウントのデータが取得されると、自動的にペルソナが生成されます：

- **投稿データ**: X APIまたはGrok Web Searchから取得
- **ペルソナプロファイル**: 投稿から口調・性格・背景を分析
- **品質スコア**: フォロワー数・最新投稿日・投稿総数から算出（0.0-1.0）

生成されたペルソナは「👤 ペルソナ分析」タブで確認できます。

---

## 4. 議論を開始する

### 4.1 議論トピックを設定

1. 「🎯 議論シミュレーション」タブを開く
2. 「💬 議論トピック」フィールドにトピックを入力
   - 例: `AIの倫理的課題について`
   - 例: `起業家精神とは何か`
   - 例: `技術と社会の関係性`

### 4.2 初回意見を生成

1. 「🚀 議論を開始」ボタンをクリック
2. 各アカウントのペルソナに基づいた初回意見が自動生成されます
3. チャット風タイムラインに全員の意見が表示されます

**生成される内容**:
- 各アカウントの口調・性格を反映した意見
- トピックに関連する過去の投稿を参考にした内容
- ペルソナの背景や専門性を反映した視点

### 4.3 表示の確認

- **吹き出し形式**: 各アカウントの意見が視覚的に分かりやすく表示
- **アバター**: 各アカウントに自動的に絵文字アバターが割り当て
- **タイムスタンプ**: 各メッセージの時刻が表示
- **ラウンド表示**: 現在のラウンド番号が上部に表示

---

## 5. 議論を展開する

### 5.1 選択的反論（推奨）

特定の人が特定の人に反論させる方法：

1. 「🔄 次のラウンドを生成」セクションで：
   - 「反論する人」ドロップダウンから反論者を選択
   - 「反論対象」ドロップダウンから反論対象を選択
2. 「💬 選択した反論を生成」ボタンをクリック
3. 選択した人の反論が生成され、タイムラインに追加されます

**特徴**:
- 議論の流れをコントロールしやすい
- 特定の対立構造を構築できる
- 文脈を考慮した反論が生成される

### 5.2 全員反論（高速展開）

全員が順番に反論する方法：

1. 「🔄 全員の反論を生成」ボタンをクリック
2. 全アカウントが順番に反論を生成します
3. ラウンドが自動的に進みます

**特徴**:
- 短時間で多様な意見を展開できる
- 全員の視点をバランスよく確認できる
- 議論が活発になる

### 5.3 ラウンドを重ねる

- ラウンドを重ねるごとに、議論が深まります
- 会話履歴を保持している場合、前のラウンドの内容を参照して反論が生成されます
- 各ラウンドで新しい視点や議論の展開が期待できます

### 5.4 新しい議論を開始

「🆕 新しい議論」ボタンをクリックすると：
- 現在の議論がリセットされます
- 会話履歴もクリアされます（会話履歴を保持している場合）
- 新しいトピックで議論を開始できます

---

## 6. 高度な使い方

### 6.1 AIエージェント機能の活用

#### マルチプラットフォーム分析

**設定**: サイドバーの「🤖 エージェント機能」セクションで「マルチプラットフォーム分析」をON

**効果**:
- X投稿だけでなく、Instagram、LinkedIn、GitHub等も検索
- ペルソナの精度が大幅に向上
- より多面的な人物像を把握

#### 会話履歴を保持

**設定**: 「会話履歴を保持」をON

**効果**:
- 複数ターンの文脈を維持
- 前のラウンドの内容を参照した反論が生成される
- より自然な議論の流れ

**使い方**:
1. 「会話履歴を保持」をON
2. 議論を開始
3. ラウンドを重ねる
4. 各反論が前の内容を参照して生成される

**クリア方法**: 「🗑️ 会話履歴をクリア」ボタンでクリア可能

#### Web検索を有効化

**設定**: 「Web検索を有効化」をON

**効果**:
- Grok Live Searchで最新情報をリアルタイム取得
- 最新のニュースや事実を反映した議論
- 根拠の強化

**推奨タイミング**:
- 時事問題や最新技術に関する議論
- 事実確認が必要な場合
- 最新のデータを反映したい場合

### 6.2 X API設定の調整

**X APIを使用する**: ON（デフォルト）
- X API v2経由で高速に投稿を取得
- 実世界指標（フォロワー数等）から品質スコアを算出

**X APIを使用しない**: OFF
- Grok Web Searchのみで投稿を取得
- レート制限を気にせずに大量候補を収集可能
- 品質スコアは暫定値になる（警告表示あり）

> 💡 **「100人の村」構築フェーズ**: X APIを無効化して、レート制限を気にせず大量候補を収集できます。後でX APIを有効化して品質スコアを算出できます。

### 6.3 キャッシュ管理

#### キャッシュを使用（デフォルト: ON）

- 以前取得したデータを再利用
- API呼び出しを大幅に削減
- レスポンス時間が98%高速化

#### 個別再取得

各アカウントの横の「🔄」ボタンで、そのアカウントだけ再取得できます。

#### 全体再取得

「🔄 全て再取得」ボタンで、全アカウントの最新データを取得します。

#### キャッシュクリア

「🗑️ キャッシュクリア」ボタンで、ファイルキャッシュを削除します。

### 6.4 大規模アカウント管理（50-100人）

#### CLIでの事前キャッシュ生成（推奨）

UIを開く前に、CLIでキャッシュを生成しておくと即座に分析を始められます：

```bash
# アカウントリストから一括取得
python ingest_accounts.py accounts.txt

# バッチサイズを調整
python ingest_accounts.py accounts.txt --batch-size 10

# X API無効化で大量収集
python ingest_accounts.py accounts.txt --no-x-api
```

**メリット**:
- レート制限を自動監視・管理
- バックグラウンドで長時間実行可能
- 詳細ログファイル (`.cache/ingest.log`)
- 中断・再開が可能（キャッシュ済みはスキップ）

#### UIでの一括管理

1. **CSV/テキストファイルで一括アップロード**: 最大100アカウントまで対応
2. **バッチ処理**: 「🚀 不足分を取得」で10件ずつ処理
3. **アカウント管理タブ**: フィルタリング・検索・ソート機能
4. **エラー一覧**: サイドバー下部でエラーアカウントを確認

### 6.5 データの確認とエクスポート

#### ペルソナ分析タブ

- 各アカウントのペルソナプロファイルを詳細表示
- 背景・性格・口調・傾向を確認

#### 投稿データタブ

- 各アカウントの投稿データを表示
- JSON形式でダウンロード可能

#### アカウント管理タブ

- ステータス別フィルタ（キャッシュ済み/取得待ち/エラー）
- アカウント名で検索
- データソース別フィルタ（Twitter/Web/Sample/Keyword/Random）
- 一括操作（再取得・エクスポート・削除）

### 6.6 品質管理

#### 品質スコア（quality_score）

- **範囲**: 0.0-1.0
- **計算式**: `0.5 * followers_norm + 0.3 * recency_norm + 0.2 * postcount_norm`
- **基準**: 0.6未満は品質基準未満として除外推奨

サイドバー下部の「📊 品質KPI」セクションで確認できます：
- 実データ比率
- 生成データ率
- 未確定ペルソナ数
- 平均/中央値quality_score

#### 運用モード

`.streamlit/secrets.toml`で`MODE = "prod"`または`MODE = "staging"`に設定すると：
- 生成フォールバックが禁止されます
- 実データのみで議論/分析が行われます
- 生成データが混入すると警告・エラー表示

---

## 🎯 推奨ワークフロー

### 基本的な使い方（1-10人）

1. ✅ アプリを起動
2. ✅ 個別にアカウントを追加（またはCSVで一括アップロード）
3. ✅ 「🚀 不足分を取得」でデータ取得
4. ✅ トピックを入力して「🚀 議論を開始」
5. ✅ 「💬 選択した反論を生成」で議論を展開

### 大規模な使い方（50-100人）

1. ✅ CLIで事前キャッシュ生成: `python ingest_accounts.py accounts.txt`
2. ✅ アプリを起動（キャッシュが自動復元される）
3. ✅ トピックを入力して「🚀 議論を開始」
4. ✅ 「🔄 全員の反論を生成」で活発に議論を展開

### 高度な使い方（AIエージェント機能）

1. ✅ 「マルチプラットフォーム分析」をON
2. ✅ 「会話履歴を保持」をON
3. ✅ 「Web検索を有効化」をON（時事問題の場合）
4. ✅ 議論を開始してラウンドを重ねる
5. ✅ 文脈を考慮した自然な議論を楽しむ

---

## 💡 よくある質問

### Q: アカウントを追加してもデータが取得されない

**A**: 
1. アカウント名を確認（@なしで入力）
2. 「🚀 不足分を取得」ボタンをクリック
3. エラー一覧を確認（サイドバー下部）
4. CLIで再取得: `python ingest_accounts.py accounts.txt`

### Q: 議論が開始できない

**A**:
1. アカウントが登録されているか確認
2. トピックを入力
3. データが取得されているか確認（「📊 投稿データ」タブ）
4. ペルソナが生成されているか確認（「👤 ペルソナ分析」タブ）

### Q: レート制限に達した

**A**:
1. UI側では警告が表示されます
2. CLI (`python ingest_accounts.py`) でバッチ生成を再実行
3. 約15分後に再試行
4. X APIを無効化してGrok Web Searchのみで取得（`--no-x-api`）

### Q: ペルソナの精度を上げたい

**A**:
1. 「マルチプラットフォーム分析」をON
2. X APIを有効化して実世界指標を取得
3. より多くの投稿を取得（CLIで再実行）
4. 品質スコア0.6以上のアカウントを使用

---

## 📚 関連ドキュメント

- `README.md` - プロジェクト概要とセットアップ
- `FEATURES.md` - 機能の詳細解説
- `AGENTS.md` - 開発者ガイド
- `X_API_SETUP.md` - X API設定ガイド

---

## 🎉 まとめ

Persona Debate Simulatorを使えば：

✅ **簡単にペルソナを作成**: Xアカウントから自動的にペルソナを生成  
✅ **リアルな議論をシミュレート**: 各ペルソナの口調・性格を反映した議論  
✅ **大規模にも対応**: 100人まで同時に議論可能  
✅ **AIエージェント機能**: 文脈維持・Web検索・マルチプラットフォーム分析  

ぜひ、様々なトピックで議論を楽しんでください！💬

